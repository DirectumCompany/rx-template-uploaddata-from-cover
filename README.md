# rx-template-upload-data-ui
Репозиторий с шаблоном разработки «Загрузка данных с обложки из xlsx-файлов».

Данный шаблон был разработан на основе шаблона компании "Роса", добавлена загрузка из базы ФИАС (ГАР) справочинков Населенные пункты, Поселения, Муниципальные районы и их иерархии.
Данный шаблон без модификации работает при установленном решении для органов государственных власти.

Для загрузки некоторых справочников (федерального классификатора обращений, муниципальных районов, поселений) необходимо решение для органов государственной власти. Если загрузка в данные справочники не требуется, то шаблон нужно модифицировать (закомментировать функции по загрузке), чтобы использовать шаблон по назначению.

## Описание
Шаблон позволяет перенести данные в Directum RX. 
Шаблон отличается от утилиты https://github.com/DirectumCompany/rx-util-importdata-net-core тем, что позволяет загружать записи с обложки модуля любым сотрудником (если есть права на справочники). Также есть различия в перечне загружаемых справочников.  
В качестве источника данных для переноса используются книги Excel с расширением XLSX.
Чтобы произвести создание записей справочников в Directum RX, достаточно заполнить специально сформированные шаблоны Excel и загрузить данные из обложки.
После каждой загрузки строится отчет об успешно/неуспешно загруженных записях.

### На текущий момент реализована возможность импорта записей следующих справочников:
1. Федеральный классификатор обращений граждан (разделы, темы, тематики, темы, вопросы, подвопросы).
2. Номенклатура дел (сроки хранения, номенклатура дел).
3. Орг. структура.

   3.1. Учетные записи.
   
   3.2. Персоны.
   
   3.3. Организации.
   
   3.4. Наши организации.
   
   3.5. Подразделения.
   
   3.6. Должности.
   
   3.7. Работники.
   
4. Населенные пункты с ГУИД ФИАС (из ФИАС (ГАР)). 
5. Муниципальные районы с ГУИД ФИАС (из ФИАС (ГАР)).
6. Поселения с ГУИД ФИАС (из ФИАС (ГАР)).

<b>Примечания</b>. 
1. Для того, чтобы в справочник населенные пункты загрузился ГУИД ФИАС, необходимо перекрыть (если он еще не перекрыт) справочник City модуля Commons и добавить новое свойство:
![image](https://github.com/DirectumCompany/rx-template-uploaddata-from-cover/assets/87016932/cbeb9c73-3ee4-4ca2-940c-e4c9f8b6d8d8)
2. Справочники Муниципальные районы, Поселения реализованы в решении для органов государственной власти. Если есть необходимость в данных справочниках, то справочники необходимо реализовать на своем слое. Для ознакомления с разработкой данных справочников необходимо обратиться в службу поддержки Directum, запросив решение.
3. Загрузка иерархии справочников по муниципальному делению (Населенные пункты -> Поселения -> Муниципальные районы) происходит с помощью плагина к утилите RxCmd, так как xml-файлы базы ФИАС (ГАР) с иерархией содержат много информации и не могут быть загружены через веб-клиент (есть ограничение в 2 мин.).

### Общий вид:
![image](https://github.com/DirectumCompany/rx-template-upload-data-ui/assets/87016932/a22ede87-a0fd-481f-b300-9b86b85d8ac5)

### Шаблоны для загрузки записей справочников (кроме шаблона для загрузки населенных пунктов)
Шаблоны можно найти в папке [Шаблоны](https://github.com/DirectumCompany/rx-template-upload-data-ui/tree/main/Template).

### Порядок загрузки населенных пунктов из ФИАС (ГАР).
1.	По ссылке https://fias.nalog.ru/Updates на вкладке ГАР БД ФИАС необходимо выполнить экспорт последней полной версии XML, находящейся в правом столбце, в формате .zip.
![image](https://github.com/DirectumCompany/rx-util-uploaddata-from-cover/assets/87016932/113a89d7-c0b5-4ef5-aceb-df86c2b237b4)
2. В экспортируемой папке находим по региону область/республику, в которую планируется импорт. Например, код Владимирской области – 33.
![image](https://github.com/DirectumCompany/rx-util-uploaddata-from-cover/assets/87016932/183e15f7-11bd-475c-8f2f-59e22341ee7c)
3.	Находящийся в папке документ в формате XML, наименование которого начинается с «AS_ADDR_OBJ_<год><месяц><день><гуид>», необходимо переместить из архивированной папки (например, на рабочий стол).
![image](https://github.com/DirectumCompany/rx-util-uploaddata-from-cover/assets/87016932/99d6aacb-2fb3-4b0c-9722-f5342cb226b5)
4. После перемещения документ необходимо открыть с помощью Excel, выбрав способ открытия файла XML-таблица.
![image](https://github.com/DirectumCompany/rx-util-uploaddata-from-cover/assets/87016932/37a2ca81-41ab-4d05-bca4-f4a99543223f)
5.	В сформировавшейся таблице в столбце Level выбираются уровни:
  
  • 5 - город;
  
  • 6 - населенный пункт.
  
<b>Примечания</b>. Отмеченные уровни импортируются в систему. Остальные уровни с шаблона необходимо удалить. Если шаблон большой, то рекомендуется разбить его на несколько примерно по 5000 записей. данное ограничение связано с тем, что для веб-клиента в системе Directum RX стоит таймаут - 2 мин.
![image](https://github.com/DirectumCompany/rx-util-uploaddata-from-cover/assets/87016932/3d3a6ac1-474b-4527-8fa5-e643570d5f6c)

6.	Получившийся документ необходимо пересохранить в формате xlsx.

7.	В системе в модуле <b>Загрузка данных</b> по гиперссылке <i>Загрузить населенные пункты</i> в полях:
![image](https://github.com/DirectumCompany/rx-util-uploaddata-from-cover/assets/87016932/63296f5c-1439-4d59-a08b-115d2e2e15fd) 
  
  • Файл* – добавляется документ с населенными пунктами;
  
  • Страна* – Российская Федерация;
  
  • Регион* – регион заказчика (например, Владимирская область).
  
8.	В модуле <b>Общие справочники</b> по гиперссылке Населенные пункты в соответствующем регионе появятся импортированные данные.

<b>Примечание</b>. Сейчас в модуле <b>Загрузка данных</b> в справочнике Населенные пункты часть населенных пунктов внесена в систему, поэтому дубль необходимо удалить. Если населенный пункт уже использовался в Системе, то необходимо из импортированного населенного пункта скопировать ИД в ФИАС, добавить его в аналогичное поле населенного пункта, который был уже использован, после чего удалить импортированный дубль из системы.

### Порядок загрузки муниципальных районов из ФИАС (ГАР).
Порядок аналогичен загрузке населенных пунктов. Выбирается тот же файл. Отличия - в пунктах 5, 7.

5.	В сформировавшейся таблице в столбце Level выбираются уровни:

     • 3 - Муниципальные районы;
  
7. В системе в модуле <b>Загрузка данных</b> по гиперссылке <i>Загрузить муниципальные районы</i> ...

### Порядок загрузки поселений из ФИАС (ГАР).
Порядок аналогичен загрузке населенных пунктов. Выбирается тот же файл. Отличия - в пунктах 5, 7.

5.	В сформировавшейся таблице в столбце Level выбираются уровни:
  
     •  4 - Сельские/Городские поселения;
  
7. В системе в модуле <b>Загрузка данных</b> по гиперссылке <i>Загрузить поселения</i> ...

### Порядок загрузки иерархии из ФИАС (ГАР).
1. Из папки lib\FIASRxCmdPlugin скопировать файлы библиотеки Sungero.RxCmd.FiasPlugin.dll, Sungero.RxCmd.FiasPlugin.pdb, Sungero.RxCmd.FiasPlugin.deps.json в папку с плагинами утилиты RxCmd \etc\\_builds\DirectumRX\RxCmd\Plugins.
2. Запустить rxcmd c параметрами:
  
  rxcmd.exe fias add_municipal_hierarchy -n "login" -p password -s "http://localhost/Integration/odata" "<Путь к файлу с иерархией>" "<Код региона>"

где

  • «fias» - имя команды первого уровня, т. е. все, что будет загружаться, выгружаться из этого модуля начинается с этой команды;
  
  • «add_municipal_hierarchy» - функция загрузки иерархии по муниципальному делению;
  
  • "<Путь к файлу с иерархией>" – путь до файла «AS_MUN_HIERARCHY_<год><месяц><день><гуид>», загруженного из ФИАС;
  
  • <Код региона> - не обязателен, сделан для оптимизации загрузки. Если указан, то поиск иерархии происходит только по загружаемому региону, иначе поиск происходит по всем данным (населенные           пункты, поселения и муниципальные районы), которые есть в системе.
  
3. Дожидаемся окончания работы. В процессе обработки на экране отображается лог обработки. Для примера, самый большой файл с иерархией Московской области (2,5 ГБ) обрабатывается в среднем за 25 мин., Удмуртской республики (500 МБ) - 4 мин.

<b>Примечания</b>. 
1. Загрузку иерархии необходимо проиводить, когда уже загружены населенные пункты, поселения, муниципальные районы.
2. Подробнее о разработке плагинов к RxCmd можно почитать https://club.directum.ru/webhelp/directumrx/web/index.html?sds_sozdanie_plagina_rxcmd.htm. 
3. Если необходимы модификации плагина, то исходный код проекта плагина находится в папке Extension\FiasRxCmdPlugin.


## Порядок установки
Для работы требуется:
1. Установленный Directum RX версии 4.6 и выше. Для более младших версий требуется модификация. Необходимо удалить/закомментировать функции, которые загружают информацию в новые справочники (Муниципальные районы, Поселения).
2. Установленное решение "Обращения граждан" (если требуется загрузка справочников федерального классификатора обращений граждан). Если данное решение не установлено, то требуется модификация. Необходимо удалить/закомментировать функции, которые загружают информацию о федеральном классификаторе обращений.

### Установка для ознакомления
1. Склонировать репозиторий https://github.com/DirectumCompany/rx-template-upload-data-ui.git в папку.
2. Указать в _ConfigSettings.xml DDS:
```xml
<block name="REPOSITORIES">
  <repository folderName="Base" solutionType="Base" url="" /> 
  <repository folderName="<Папка из п.1>" solutionType="Work" 
     url="https://github.com/DirectumCompany/rx-template-upload-data-ui.git" />
</block>
```
### Установка для использования на проекте

Возможные варианты:

#### A. Fork репозитория.
1. Сделать fork репозитория rx-template-upload-data-ui для своей учетной записи.
2. Склонировать созданный в п. 1 репозиторий в папку.
3. Указать в _ConfigSettings.xml DDS:
``` xml
<block name="REPOSITORIES">
  <repository folderName="Base" solutionType="Base" url="" /> 
  <repository folderName="<Папка из п.2>" solutionType="Work" 
     url="<Адрес репозитория gitHub учетной записи пользователя из п. 1>" />
</block>
```
#### B. Подключение на базовый слой.
Вариант не рекомендуется, так как при выходе версии шаблона разработки не гарантируется обратная совместимость.
1. Склонировать репозиторий https://github.com/DirectumCompany/rx-template-upload-data-ui.git в папку.
2. Указать в _ConfigSettings.xml DDS:
```xml
<block name="REPOSITORIES">
  <repository folderName="Base" solutionType="Base" url="" /> 
  <repository folderName="<Папка из п.1>" solutionType="Base" 
     url="https://github.com/DirectumCompany/rx-template-upload-data-ui.git" />
  <repository folderName="<Папка для рабочего слоя>" solutionType="Work" 
     url="<Адрес репозитория для рабочего слоя>" />
</block>
```

#### C. Копирование репозитория в систему контроля версий.
Рекомендуемый вариант для проектов внедрения.
1. В системе контроля версий с поддержкой git создать новый репозиторий.
2. Склонировать репозиторий https://github.com/DirectumCompany/rx-template-upload-data-ui.git в папку с ключом --mirror.
3. Перейти в папку из п. 2.
4. Импортировать клонированный репозиторий в систему контроля версий командой:
git push –mirror <Адрес репозитория из п. 1>
